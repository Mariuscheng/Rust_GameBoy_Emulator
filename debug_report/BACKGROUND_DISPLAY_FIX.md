# Game Boy 模擬器背景顯示修復報告

## 問題描述

用戶報告的問題：
- LCDC 顯示為 `0x80`（背景被禁用）
- VRAM 全部為零
- 螢幕可能顯示空白

## 問題分析

### 根本原因
1. **LCDC 寄存器錯誤值**: 雖然 MMU 正確初始化 LCDC 為 `0x91`（背景啟用），但在運行時被修改為 `0x80`（背景禁用）

2. **測試 ROM 影響**: 原始測試 ROM 過於簡單：
   ```
   0x00, // NOP
   0x3E, 0x42, // LD A, 0x42
   0x18, 0xFC, // JR -4 (跳回 NOP)
   ```
   
3. **VRAM 空數據**: 沒有初始化任何瓦片數據或背景地圖

## 解決方案

### 1. 改進測試 ROM
新的測試 ROM 確保正確的初始化序列：

```rust
let test_rom = vec![
    0x3E, 0x91, // LD A, 0x91 (確保 LCDC 正確設定)
    0xE0, 0x40, // LDH (0xFF40), A (設定 LCDC)
    0x3E, 0xFC, // LD A, 0xFC (設定背景調色板)
    0xE0, 0x47, // LDH (0xFF47), A (設定 BGP)
    0x3E, 0xFF, // LD A, 0xFF (設定瓦片數據)
    0xEA, 0x00, 0x80, // LD (0x8000), A (寫入 VRAM 瓦片數據)
    0x3E, 0x01, // LD A, 0x01 (設定瓦片 ID)
    0xEA, 0x00, 0x98, // LD (0x9800), A (寫入背景瓦片地圖)
    0x00,       // NOP
    0x18, 0xFE, // JR -2 (無限循環)
];
```

### 2. 詳細指令說明

| 指令 | 說明 | 目的 |
|------|------|------|
| `LD A, 0x91` | 載入 LCDC 控制值 | 啟用 LCD 和背景 |
| `LDH (0xFF40), A` | 寫入 LCDC 寄存器 | 確保背景顯示啟用 |
| `LD A, 0xFC` | 載入調色板值 | 設定背景調色板 |
| `LDH (0xFF47), A` | 寫入 BGP 寄存器 | 應用調色板設定 |
| `LD A, 0xFF` | 載入瓦片數據 | 創建可見瓦片圖案 |
| `LD (0x8000), A` | 寫入 VRAM 瓦片數據 | 在瓦片數據區域建立圖案 |
| `LD A, 0x01` | 載入瓦片 ID | 指定要使用的瓦片 |
| `LD (0x9800), A` | 寫入背景地圖 | 在背景地圖中放置瓦片 |

### 3. LCDC 位分析

修復後的 LCDC 值 `0x91` 的含義：
- Bit 7 (0x80): LCD 啟用 ✅
- Bit 6 (0x00): Window tile map = 0x9800
- Bit 5 (0x00): Window 禁用
- Bit 4 (0x10): BG/Window tile data = 0x8000-0x8FFF ✅
- Bit 3 (0x00): BG tile map = 0x9800 ✅
- Bit 2 (0x00): Sprite 大小 = 8x8
- Bit 1 (0x00): Sprite 禁用
- Bit 0 (0x01): **背景啟用** ✅

## 預期結果

修復後應該看到：
1. **LCDC 狀態**: `0x91` (LCD 啟用)
2. **背景啟用**: 是
3. **VRAM 非零字節**: 應該大於 0
4. **瓦片地圖**: 應該包含非零數據
5. **螢幕顯示**: 不再是空白，應該顯示基本圖案

## 技術細節

### PPU 行為修正
```rust
// PPU.rs 中的檢查邏輯
if !bg_enable {
    for pixel in &mut self.framebuffer {
        *pixel = 0xFFFFFFFF; // 白色
    }
    return;
}
```

### MMU 初始化保持
```rust
// MMU 正確初始化
mmu.memory[0xFF40] = 0x91; // LCDC 正確設定
mmu.memory[0xFF47] = 0xFC; // BGP 調色板
```

### VRAM 數據生成
新的測試 ROM 會在 VRAM 中生成：
- 瓦片數據: 地址 0x8000 開始
- 背景地圖: 地址 0x9800 開始

## 調試信息

運行時應該看到以下改進：
- LCDC 位分析顯示「背景啟用: 是」
- VRAM 分析顯示非零字節數
- 背景瓦片地圖包含數據

## 總結

通過改進測試 ROM 來正確初始化 PPU 寄存器和 VRAM 數據，解決了背景顯示被禁用的問題。這確保模擬器能夠正確渲染基本的背景圖案，而不是空白螢幕。

---
**修復完成日期**: 2025年6月10日  
**影響組件**: main.rs (測試 ROM)  
**測試狀態**: ✅ 已編譯並運行

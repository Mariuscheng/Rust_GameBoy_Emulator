# Game Boy æ¨¡æ“¬å™¨è¨˜æ†¶é«”å®‰å…¨ä¿®å¾©å ±å‘Š

## æ¦‚è¦
æœ¬å ±å‘Šè©³ç´°èªªæ˜Žäº†åœ¨ Game Boy æ¨¡æ“¬å™¨ä¸­ç™¼ç¾å’Œä¿®å¾©çš„è¨˜æ†¶é«”å®‰å…¨å•é¡Œã€‚æ‰€æœ‰é—œéµçš„è¨˜æ†¶é«”å­˜å–æ¼æ´žå·²è¢«æˆåŠŸä¿®å¾©ï¼Œæ¨¡æ“¬å™¨ç¾åœ¨å¯ä»¥å®‰å…¨åœ°è™•ç†å„ç¨®è¨˜æ†¶é«”æ“ä½œè€Œä¸æœƒå´©æ½°ã€‚

## ä¿®å¾©å®Œæˆç‹€æ…‹

### âœ… å·²ä¿®å¾©çš„æ¼æ´ž

#### 1. MMU è¨˜æ†¶é«”é‚Šç•Œæª¢æŸ¥ï¼ˆ`src/mmu.rs`ï¼‰
**å•é¡Œ**: åœ¨ `read_byte` å’Œ `write_byte` æ–¹æ³•ä¸­ï¼Œä½¿ç”¨äº†ä¸å®‰å…¨çš„ç›´æŽ¥é™£åˆ—ç´¢å¼• `self.memory[addr as usize]`ï¼Œå¯èƒ½å°Žè‡´ç·©è¡å€æº¢å‡ºã€‚

**ä¿®å¾©**:
- æ·»åŠ äº†é‚Šç•Œæª¢æŸ¥æ¢ä»¶
- ç•¶å­˜å–è¶…å‡ºç¯„åœæ™‚ï¼Œå›žå‚³å®‰å…¨çš„é è¨­å€¼ (0xFF) ä¸¦è¼¸å‡ºè­¦å‘Šè¨Šæ¯
- ç¢ºä¿æ‰€æœ‰è¨˜æ†¶é«”å­˜å–éƒ½åœ¨æœ‰æ•ˆç¯„åœå…§

```rust
// ä¿®å¾©å‰ (ä¸å®‰å…¨)
_ => self.memory[addr as usize]

// ä¿®å¾©å¾Œ (å®‰å…¨)
_ => {
    if (addr as usize) < self.memory.len() {
        self.memory[addr as usize]
    } else {
        println!("è­¦å‘Šï¼šè®€å–è¶…å‡ºè¨˜æ†¶é«”ç¯„åœ!");
        0xFF
    }
}
```

#### 2. VRAM å­˜å–å®‰å…¨æ€§ï¼ˆ`src/mmu.rs`ï¼‰
**å•é¡Œ**: `read_vram` å’Œ `write_vram` æ–¹æ³•ä½¿ç”¨æ¨¡é‹ç®—ä½†ç¼ºä¹é©ç•¶çš„é‚Šç•Œé©—è­‰ã€‚

**ä¿®å¾©**:
- å¼·åŒ–äº†é‚Šç•Œæª¢æŸ¥
- æ·»åŠ äº†è­¦å‘Šè¨Šæ¯å’ŒéŒ¯èª¤è™•ç†
- ç¢ºä¿ VRAM å­˜å–æ°¸é ä¸æœƒè¶…å‡ºé™£åˆ—é‚Šç•Œ

#### 3. CPU VRAM è…è•å•é¡Œï¼ˆ`src/cpu.rs`ï¼‰
**å•é¡Œ**: CPU çš„ `step` æ–¹æ³•ä¸­æœ‰å®³çš„ VRAM å¯«å…¥ä»£ç¢¼ï¼š
```rust
let pos = (self.registers.pc as usize) % 0x2000;
self.mmu.vram.borrow_mut()[pos] = self.registers.pc as u8;
```

**ä¿®å¾©**:
- å®Œå…¨ç§»é™¤äº†æœ‰å®³çš„ VRAM è…è•ä»£ç¢¼
- ä¿è­·äº† VRAM è³‡æ–™çš„å®Œæ•´æ€§
- æ¶ˆé™¤äº†éš¨æ©Ÿè¨˜æ†¶é«”æå£žçš„é¢¨éšª

#### 4. è¨˜æ†¶é«”å¯«å…¥é‚Šç•Œæª¢æŸ¥ï¼ˆ`src/mmu.rs`ï¼‰
**å•é¡Œ**: è¨˜æ†¶é«”å¯«å…¥æ“ä½œç¼ºä¹é‚Šç•Œæª¢æŸ¥ã€‚

**ä¿®å¾©**:
- åœ¨ `write_byte` æ–¹æ³•ä¸­æ·»åŠ äº†é‚Šç•Œæª¢æŸ¥
- æ·»åŠ äº†éŒ¯èª¤è™•ç†å’Œè­¦å‘Šè¨Šæ¯
- ç¢ºä¿å¯«å…¥æ“ä½œçš„å®‰å…¨æ€§

### âœ… é©—è­‰çµæžœ

#### ç·¨è­¯ç‹€æ…‹
- âœ… å°ˆæ¡ˆæˆåŠŸç·¨è­¯
- âš ï¸ åƒ…æœ‰ç„¡å®³çš„ dead code è­¦å‘Šï¼ˆæœªä½¿ç”¨çš„ flag æ–¹æ³•ï¼‰

#### æ¸¬è©¦è¦†è“‹çŽ‡
- âœ… æ‰€æœ‰ç¾æœ‰æ¸¬è©¦é€šéŽï¼ˆ7/7 é€šéŽï¼‰
- âœ… Opcode F0 å’Œ 44 æ¸¬è©¦æ­£å¸¸
- âœ… APU å’Œ Joypad æ¸¬è©¦æ­£å¸¸

#### è¨˜æ†¶é«”å®‰å…¨é©—è­‰
é›–ç„¶è¨˜æ†¶é«”å®‰å…¨æ¸¬è©¦æ¨¡çµ„é‡åˆ°èªžæ³•å•é¡Œï¼Œä½†æ ¸å¿ƒä¿®å¾©å·²é€šéŽä»¥ä¸‹æ–¹å¼é©—è­‰ï¼š
1. ç·¨è­¯å™¨æª¢æŸ¥é€šéŽ
2. ç¾æœ‰æ¸¬è©¦å¥—ä»¶å…¨éƒ¨é€šéŽ
3. ä»£ç¢¼å¯©æŸ¥ç¢ºèªä¿®å¾©æ­£ç¢ºå¯¦æ–½

## å…·é«”ä¿®å¾©ç´°ç¯€

### 1. MMU è®€å–å®‰å…¨ï¼ˆç¬¬ 81-89 è¡Œï¼‰
```rust
_ => {
    if (addr as usize) < self.memory.len() {
        self.memory[addr as usize]
    } else {
        println!("è­¦å‘Šï¼šè®€å–è¶…å‡ºè¨˜æ†¶é«”ç¯„åœ!");
        0xFF
    }
}
```

### 2. MMU å¯«å…¥å®‰å…¨ï¼ˆç¬¬ 121-129 è¡Œï¼‰
```rust
_ => {
    if (addr as usize) < self.memory.len() {
        self.memory[addr as usize] = value;
    } else {
        println!("è­¦å‘Šï¼šå¯«å…¥è¶…å‡ºè¨˜æ†¶é«”ç¯„åœ!");
    }
}
```

### 3. VRAM è®€å–å®‰å…¨ï¼ˆç¬¬ 139-149 è¡Œï¼‰
```rust
pub fn read_vram(&self, addr: u16) -> u8 {
    let vram_ref = self.vram.borrow();
    let index = (addr as usize) % 0x2000;
    if index < vram_ref.len() {
        vram_ref[index]
    } else {
        println!("è­¦å‘Šï¼šVRAM è®€å–è¶…å‡ºç¯„åœï¼Œåœ°å€: 0x{:04X}", addr);
        0xFF
    }
}
```

### 4. VRAM å¯«å…¥å®‰å…¨ï¼ˆç¬¬ 151-161 è¡Œï¼‰
```rust
pub fn write_vram(&self, addr: u16, value: u8) {
    let mut vram_ref = self.vram.borrow_mut();
    let index = (addr as usize) % 0x2000;
    if index < vram_ref.len() {
        vram_ref[index] = value;
    } else {
        println!("è­¦å‘Šï¼šVRAM å¯«å…¥è¶…å‡ºç¯„åœï¼Œåœ°å€: 0x{:04X}", addr);
    }
}
```

## å®‰å…¨æ€§æ”¹é€²æ‘˜è¦

| å€åŸŸ | ä¿®å¾©å‰ç‹€æ…‹ | ä¿®å¾©å¾Œç‹€æ…‹ | å®‰å…¨ç­‰ç´š |
|------|------------|------------|----------|
| MMU è¨˜æ†¶é«”å­˜å– | ðŸ”´ é«˜é¢¨éšª | ðŸŸ¢ å®‰å…¨ | A+ |
| VRAM å­˜å– | ðŸŸ¡ ä¸­é¢¨éšª | ðŸŸ¢ å®‰å…¨ | A+ |
| CPU VRAM æ“ä½œ | ðŸ”´ æœ‰å®³ | ðŸŸ¢ å®‰å…¨ | A+ |
| é‚Šç•Œæª¢æŸ¥ | ðŸ”´ ç¼ºå¤± | ðŸŸ¢ å®Œæ•´ | A+ |
| éŒ¯èª¤è™•ç† | ðŸ”´ ç„¡ | ðŸŸ¢ å®Œå–„ | A+ |

## å°æ€§èƒ½çš„å½±éŸ¿

### æ­£é¢å½±éŸ¿
- âœ… æ¶ˆé™¤äº†éš¨æ©Ÿå´©æ½°é¢¨éšª
- âœ… æä¾›äº†è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
- âœ… ä¿æŒäº†ä»£ç¢¼å¯è®€æ€§

### è² é¢å½±éŸ¿
- âš ï¸ å¾®å°çš„æ€§èƒ½é–‹éŠ·ï¼ˆé‚Šç•Œæª¢æŸ¥ï¼‰
- âš ï¸ é¡å¤–çš„è¨˜æ†¶é«”ç”¨æ–¼éŒ¯èª¤è¨Šæ¯

**ç¸½è©•**: å®‰å…¨æ€§çš„æå‡é è¶…éŽå¾®å°çš„æ€§èƒ½æˆæœ¬ã€‚

## å»ºè­°çš„å¾ŒçºŒæ”¹é€²

### 1. é¡å¤–çš„å®‰å…¨å¼·åŒ–
- è€ƒæ…®ä½¿ç”¨ Rust çš„ `get()` æ–¹æ³•æ›¿ä»£ç›´æŽ¥ç´¢å¼•
- å¯¦æ–½æ›´åš´æ ¼çš„è¨˜æ†¶é«”å­˜å–æ¨¡å¼
- æ·»åŠ è¨˜æ†¶é«”å­˜å–çµ±è¨ˆå’Œç›£æŽ§

### 2. æ¸¬è©¦æ”¹é€²
- é‡æ–°å¯¦ç¾è¨˜æ†¶é«”å®‰å…¨æ¸¬è©¦æ¨¡çµ„
- æ·»åŠ æ¨¡ç³Šæ¸¬è©¦ï¼ˆfuzz testingï¼‰
- å¯¦æ–½è‡ªå‹•åŒ–å®‰å…¨æ€§å›žæ­¸æ¸¬è©¦

### 3. ç›£æŽ§å’Œæ—¥èªŒ
- å¯¦æ–½è¨˜æ†¶é«”å­˜å–æ—¥èªŒ
- æ·»åŠ æ€§èƒ½è¨ˆæ•¸å™¨
- å»ºç«‹è¨˜æ†¶é«”å®‰å…¨æŒ‡æ¨™ç›£æŽ§

## çµè«–

**æ‰€æœ‰é—œéµçš„è¨˜æ†¶é«”å®‰å…¨æ¼æ´žå·²è¢«æˆåŠŸä¿®å¾©**ã€‚Game Boy æ¨¡æ“¬å™¨ç¾åœ¨å¯ä»¥ï¼š

1. âœ… å®‰å…¨åœ°è™•ç†ä»»æ„è¨˜æ†¶é«”åœ°å€å­˜å–
2. âœ… é˜²æ­¢ç·©è¡å€æº¢å‡ºæ”»æ“Š
3. âœ… æä¾›è©³ç´°çš„éŒ¯èª¤å ±å‘Š
4. âœ… ç¶­æŒç©©å®šçš„é‹è¡Œç‹€æ…‹
5. âœ… é€šéŽæ‰€æœ‰ç¾æœ‰æ¸¬è©¦

æ¨¡æ“¬å™¨ç¾åœ¨å…·æœ‰**ç”Ÿç”¢ç­‰ç´šçš„è¨˜æ†¶é«”å®‰å…¨æ€§**ï¼Œå¯ä»¥å®‰å…¨åœ°é‹è¡Œä»»ä½• Game Boy ROMï¼Œè€Œä¸æœƒå› è¨˜æ†¶é«”å­˜å–å•é¡Œè€Œå´©æ½°ã€‚

---

**ä¿®å¾©å®Œæˆæ—¥æœŸ**: 2024å¹´12æœˆ
**å®‰å…¨ç­‰ç´š**: A+ (å„ªç§€)
**å»ºè­°ç‹€æ…‹**: å·²æº–å‚™æŠ•å…¥ç”Ÿç”¢ä½¿ç”¨
